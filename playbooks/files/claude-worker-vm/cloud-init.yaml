#cloud-config

users:
  - default
  - name: ubuntu
    sudo: ALL=(ALL) NOPASSWD:ALL
    shell: /bin/zsh
    ssh_authorized_keys:
      - {{ ssh_public_key }}

package_update: true

packages:
  - xauth
  - x11-apps
  - curl
  - git
  - build-essential
  - docker.io
  - docker-compose-v2
  - dunst
  - zsh
  - fzf
  - tree
  - xclip
  # dunst for notifications
  - dunst

write_files:
  # Bash aliases and functions
  - path: /home/ubuntu/.bash_aliases
    owner: ubuntu:ubuntu
    permissions: '0644'
    content: |
      # Safety aliases
      alias rm='rm -i'
      alias cp='cp -i'
      alias mv='mv -i'

      # Navigation
      alias ..='cd ..'
      alias ...='cd ../..'
      alias ....='cd ../../..'
      alias j='jean'

      # Listing
      alias ll='ls -alF'
      alias la='ls -A'
      alias l='ls -CF'

      # Convenience
      alias h='history'
      alias grep='grep --color=auto'
      alias df='df -h'
      alias du='du -h'
      alias chrome="google-chrome"

      # Git worktree aliases
      alias gwt='git worktree'
      alias gwta='git worktree add'
      alias gwtl='git worktree list'
      alias gwtr='git worktree remove'
      alias gwtp='git worktree prune'

      # Claude
      alias claude='claude --dangerously-skip-permissions'
      alias claudec='claude --chrome'

      # Copy
      alias copy='xclip -selection clipboard'

      # Start dunst notification daemon if not running
      pgrep -x dunst > /dev/null || (dunst &)

      # Find file and copy path to clipboard
      lsc() {
        if [ -z "$1" ]; then
          echo "Usage: lsc <pattern>"
          return 1
        fi

        local matches=$(find . -iname "*$1*" 2>/dev/null | awk '{print length, $0}' | sort -n | cut -d' ' -f2-)

        if [ -z "$matches" ]; then
          echo "No matches found for: $1"
          return 1
        fi

        local closest=$(echo "$matches" | head -n1)
        local full_path=$(realpath "$closest")

        echo "$full_path" | copy

        echo "Matches:"
        echo "$matches" | while read -r match; do
          if [ "$match" = "$closest" ]; then
            echo "  âœ“ $match"
          else
            echo "    $match"
          fi
        done

        echo ""
        echo "Copied: $full_path"
      }

  # Bashrc additions (OSC 7 for terminal emulators)
  - path: /home/ubuntu/.bashrc_additions
    owner: ubuntu:ubuntu
    permissions: '0644'
    content: |
      # Emit OSC 7 escape sequence with hostname for terminal emulators
      __osc7_cwd() {
          printf '\033]7;file://%s%s\033\\' "$(hostname)" "$PWD"
      }
      PROMPT_COMMAND="__osc7_cwd${PROMPT_COMMAND:+;$PROMPT_COMMAND}"

      # Start dunst notification daemon if not running (requires X11/DISPLAY)
      if [ -n "$DISPLAY" ]; then
          pgrep -x dunst > /dev/null || (dunst &)
      fi

  # Zshrc additions (OSC 7 for terminal emulators)
  - path: /home/ubuntu/.zshrc_additions
    owner: ubuntu:ubuntu
    permissions: '0644'
    content: |
      # Emit OSC 7 escape sequence with hostname for terminal emulators
      __osc7_cwd() {
          printf '\033]7;file://%s%s\033\\' "$(hostname)" "$PWD"
      }
      precmd_functions+=(__osc7_cwd)

      # Start dunst notification daemon if not running (requires X11/DISPLAY)
      if [ -n "$DISPLAY" ]; then
          pgrep -x dunst > /dev/null || (dunst &)
      fi

runcmd:
  # Configure SSH for X11 forwarding
  - sed -i 's/#X11Forwarding.*/X11Forwarding yes/' /etc/ssh/sshd_config
  - sed -i 's/#X11UseLocalhost.*/X11UseLocalhost no/' /etc/ssh/sshd_config
  - systemctl restart sshd

  # Install Google Chrome (official .deb, works with X11 forwarding)
  - wget -q https://dl.google.com/linux/direct/google-chrome-stable_current_amd64.deb -O /tmp/chrome.deb
  - apt-get install -y /tmp/chrome.deb
  - rm /tmp/chrome.deb

  # Install UV
  - curl -LsSf https://astral.sh/uv/install.sh | sh

  # Install Node.js and Claude Code
  - curl -fsSL https://deb.nodesource.com/setup_22.x | bash -
  - apt-get install -y nodejs
  - npm install -g @anthropic-ai/claude-code

  # Install git-delta (better git diffs)
  - wget -q https://github.com/dandavison/delta/releases/download/0.18.2/git-delta_0.18.2_amd64.deb -O /tmp/git-delta.deb
  - dpkg -i /tmp/git-delta.deb
  - rm /tmp/git-delta.deb

  # Configure git
  - sudo -u ubuntu git config --global user.name "danielr"
  - sudo -u ubuntu git config --global user.email "danielratmiroff@gmail.com"
  - sudo -u ubuntu git config --global core.editor "vim"
  - sudo -u ubuntu git config --global core.pager delta
  - sudo -u ubuntu git config --global interactive.diffFilter 'delta --color-only'
  - sudo -u ubuntu git config --global delta.navigate true
  - sudo -u ubuntu git config --global delta.dark true
  - sudo -u ubuntu git config --global merge.conflictStyle zdiff3

  # Configure Claude Code sandbox settings
  # - mkdir -p /home/ubuntu/.claude
  # - |
  #   cat > /home/ubuntu/.claude/settings.json << 'EOF'
  #   {
  #     "sandbox": {
  #       "enabled": true,
  #       "mode": "auto-allow"
  #     }
  #   }
  #   EOF
  # - chown -R ubuntu:ubuntu /home/ubuntu/.claude
  #
  # Add ubuntu user to docker group
  - usermod -aG docker ubuntu

  # Install GitHub CLI (gh)
  - mkdir -p -m 755 /etc/apt/keyrings
  - wget -nv -O /tmp/githubcli-archive-keyring.gpg https://cli.github.com/packages/githubcli-archive-keyring.gpg
  - cat /tmp/githubcli-archive-keyring.gpg | tee /etc/apt/keyrings/githubcli-archive-keyring.gpg > /dev/null
  - chmod go+r /etc/apt/keyrings/githubcli-archive-keyring.gpg
  - echo "deb [arch=amd64 signed-by=/etc/apt/keyrings/githubcli-archive-keyring.gpg] https://cli.github.com/packages stable main" | tee /etc/apt/sources.list.d/github-cli.list > /dev/null
  - apt-get update
  - apt-get install -y gh

  # Append bashrc additions (OSC 7 for terminal emulators)
  - cat /home/ubuntu/.bashrc_additions >> /home/ubuntu/.bashrc

  # Install Oh My Zsh for ubuntu user
  - sudo -u ubuntu sh -c "$(wget -O- https://github.com/deluan/zsh-in-docker/releases/download/v1.2.0/zsh-in-docker.sh)" -- -p git -p fzf -a zsh-users/zsh-autosuggestions -a zsh-users/zsh-completions -x

  # Configure zsh
  - echo 'source /usr/share/doc/fzf/examples/key-bindings.zsh' >> /home/ubuntu/.zshrc
  - echo 'source /usr/share/doc/fzf/examples/completion.zsh' >> /home/ubuntu/.zshrc
  - echo 'source ~/.bash_aliases' >> /home/ubuntu/.zshrc
  - cat /home/ubuntu/.zshrc_additions >> /home/ubuntu/.zshrc
  - echo 'export PATH="$HOME/.local/bin:$PATH"' >> ~/.zshrc && source ~/.zshrc
