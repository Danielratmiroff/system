#cloud-config

users:
  - default
  - name: ubuntu
    sudo: ALL=(ALL) NOPASSWD:ALL
    shell: /bin/bash
    ssh_authorized_keys:
      - {{ ssh_public_key }}

package_update: true

packages:
  - xauth
  - x11-apps
  - curl
  - git
  - build-essential

runcmd:
  # Configure SSH for X11 forwarding
  - sed -i 's/#X11Forwarding.*/X11Forwarding yes/' /etc/ssh/sshd_config
  - sed -i 's/#X11UseLocalhost.*/X11UseLocalhost no/' /etc/ssh/sshd_config
  - systemctl restart sshd
  # Install Google Chrome (official .deb, works with X11 forwarding)
  - wget -q https://dl.google.com/linux/direct/google-chrome-stable_current_amd64.deb -O /tmp/chrome.deb
  - apt-get install -y /tmp/chrome.deb
  - rm /tmp/chrome.deb
  # Install UV
  - curl -LsSf https://astral.sh/uv/install.sh | sh
  # Install Node.js and Claude Code
  - curl -fsSL https://deb.nodesource.com/setup_22.x | bash -
  - apt-get install -y nodejs
  - npm install -g @anthropic-ai/claude-code
  - sudo -u ubuntu git config --global user.name "danielr"
  - sudo -u ubuntu git config --global user.email "danielratmiroff@gmail.com"
  # Configure Claude Code sandbox settings
  # - mkdir -p /home/ubuntu/.claude
  # - |
  #   cat > /home/ubuntu/.claude/settings.json << 'EOF'
  #   {
  #     "sandbox": {
  #       "enabled": true,
  #       "mode": "auto-allow"
  #     }
  #   }
  #   EOF
  # - chown -R ubuntu:ubuntu /home/ubuntu/.claude
  # Install Docker Engine (official repository)
  - curl -fsSL https://download.docker.com/linux/ubuntu/gpg | gpg --dearmor -o /usr/share/keyrings/docker-archive-keyring.gpg
  - echo "deb [arch=amd64 signed-by=/usr/share/keyrings/docker-archive-keyring.gpg] https://download.docker.com/linux/ubuntu noble main" > /etc/apt/sources.list.d/docker.list
  - apt-get update
  - apt-get install -y docker-ce docker-ce-cli containerd.io
  - usermod -aG docker ubuntu
  # Install GitHub CLI (gh)
  - mkdir -p -m 755 /etc/apt/keyrings
  - wget -nv -O /tmp/githubcli-archive-keyring.gpg https://cli.github.com/packages/githubcli-archive-keyring.gpg
  - cat /tmp/githubcli-archive-keyring.gpg | tee /etc/apt/keyrings/githubcli-archive-keyring.gpg > /dev/null
  - chmod go+r /etc/apt/keyrings/githubcli-archive-keyring.gpg
  - echo "deb [arch=amd64 signed-by=/etc/apt/keyrings/githubcli-archive-keyring.gpg] https://cli.github.com/packages stable main" | tee /etc/apt/sources.list.d/github-cli.list > /dev/null
  - apt-get update
  - apt-get install -y gh
  # Configure bash aliases for ubuntu user
  - |
    cat > /home/ubuntu/.bash_aliases << 'EOF'
    # Safety aliases
    alias rm='rm -i'
    alias cp='cp -i'
    alias mv='mv -i'

    # Navigation
    alias ..='cd ..'
    alias ...='cd ../..'
    alias ....='cd ../../..'

    # Listing
    alias ll='ls -alF'
    alias la='ls -A'
    alias l='ls -CF'

    # Convenience
    alias cls='clear'
    alias h='history'
    alias grep='grep --color=auto'
    alias df='df -h'
    alias du='du -h'

    # Claude
    alias claude='claude --dangerously-skip-permissions'
    alias claudec='claude --chrome'

    EOF
  - chown ubuntu:ubuntu /home/ubuntu/.bash_aliases
  # Add OSC 7 escape sequence for terminal emulators (wezterm, kitty, etc.)
  - |
    cat >> /home/ubuntu/.bashrc << 'EOF'

    # Emit OSC 7 escape sequence with hostname for terminal emulators
    __osc7_cwd() {
        printf '\033]7;file://%s%s\033\\' "$(hostname)" "$PWD"
    }
    PROMPT_COMMAND="__osc7_cwd${PROMPT_COMMAND:+;$PROMPT_COMMAND}"
    EOF
