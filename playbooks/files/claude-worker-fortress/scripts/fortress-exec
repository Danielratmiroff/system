#!/bin/bash
# =============================================================================
# fortress-exec - Execute command in running Claude Fortress container
# =============================================================================
# Usage: fortress-exec [command] [args...]
#
# Executes a command inside the running devcontainer. If no command is
# specified, opens an interactive bash shell.
#
# Environment:
#   FORTRESS_WORKSPACE - Override workspace folder (default: current directory)
# =============================================================================

set -euo pipefail

# Colors for output
RED='\033[0;31m'
BLUE='\033[0;34m'
NC='\033[0m'

log_info() { echo -e "${BLUE}[INFO]${NC} $1"; }
log_error() { echo -e "${RED}[ERROR]${NC} $1"; }

# Configuration
WORKSPACE="${FORTRESS_WORKSPACE:-.}"
WORKSPACE=$(realpath "$WORKSPACE" 2>/dev/null || echo "$WORKSPACE")

# Default command is bash
if [[ $# -eq 0 ]]; then
    CMD="bash"
else
    CMD="$*"
fi

# Validate devcontainer CLI is installed
if ! command -v devcontainer &>/dev/null; then
    log_error "devcontainer CLI not found"
    echo "Install with: npm install -g @devcontainers/cli"
    exit 1
fi

# Validate .devcontainer exists
if [[ ! -d "$WORKSPACE/.devcontainer" ]]; then
    log_error "No .devcontainer found in $WORKSPACE"
    echo "Are you in the right directory? Current: $WORKSPACE"
    exit 1
fi

# Execute command in container
exec devcontainer exec --workspace-folder "$WORKSPACE" $CMD
