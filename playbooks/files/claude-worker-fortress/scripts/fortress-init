#!/bin/bash
# =============================================================================
# fortress-init - Initialize a project with Claude Fortress devcontainer
# =============================================================================
# Usage: fortress-init [project-path]
#
# Copies the fortress devcontainer template to a project's .devcontainer/
# directory, enabling the devcontainers CLI workflow.
# =============================================================================

set -euo pipefail

# Colors for output
GREEN='\033[0;32m'
RED='\033[0;31m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m'

log_info() { echo -e "${BLUE}[INFO]${NC} $1"; }
log_success() { echo -e "${GREEN}[SUCCESS]${NC} $1"; }
log_error() { echo -e "${RED}[ERROR]${NC} $1"; }
log_warn() { echo -e "${YELLOW}[WARN]${NC} $1"; }

# Configuration
PROJECT_PATH="${1:-.}"
TEMPLATE_DIR="${FORTRESS_TEMPLATE_DIR:-$HOME/fortress/template}"

# Convert to absolute path
PROJECT_PATH=$(realpath "$PROJECT_PATH" 2>/dev/null || echo "$PROJECT_PATH")

# Validate template exists
if [[ ! -d "$TEMPLATE_DIR" ]]; then
    log_error "Template directory not found: $TEMPLATE_DIR"
    log_info "Ensure the fortress template is installed at $TEMPLATE_DIR"
    exit 1
fi

# Check if .devcontainer already exists
if [[ -d "$PROJECT_PATH/.devcontainer" ]]; then
    log_error ".devcontainer already exists in $PROJECT_PATH"
    log_info "Remove it first if you want to reinitialize: rm -rf $PROJECT_PATH/.devcontainer"
    exit 1
fi

# Create .devcontainer directory
log_info "Initializing Claude Fortress for: $PROJECT_PATH"
mkdir -p "$PROJECT_PATH/.devcontainer"

# Copy template files
log_info "Copying template files from $TEMPLATE_DIR..."
cp -r "$TEMPLATE_DIR"/* "$PROJECT_PATH/.devcontainer/"

# Set permissions
chmod +x "$PROJECT_PATH/.devcontainer/entrypoint.sh" 2>/dev/null || true
chmod +x "$PROJECT_PATH/.devcontainer/init-firewall.sh" 2>/dev/null || true

# Success message
log_success "Initialized .devcontainer in $PROJECT_PATH"
echo ""
echo "Files created:"
ls -la "$PROJECT_PATH/.devcontainer/"
echo ""
echo "Next steps:"
echo "  1. cd $PROJECT_PATH"
echo "  2. export VNC_PASSWORD='your-secure-password'"
echo "  3. fortress-up"
echo ""
echo "Or to customize:"
echo "  Edit $PROJECT_PATH/.devcontainer/devcontainer.json"
