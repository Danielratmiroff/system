---
# Filename: share_configs_with_claude.yml
#
# Ansible Playbook to share Daniel's configurations with the Claude user.
#
# This playbook will:
# 1. Copy Git configuration (.gitconfig)
# 2. Copy SSH config (without private keys)
# 3. Configure X11 display access
# 4. Configure SSH agent forwarding via ACL and environment
# 5. Grant Daniel ACL access to Claude's home directory

- name: Share Daniel's Configurations with Claude User
  hosts: localhost
  gather_facts: false

  vars:
    source_user: "daniel"
    target_user: "claude"
    source_home: "/home/daniel"
    target_home: "/home/claude"
    daniel_uid: "1000"

  tasks:
    #########################################################
    # Section 1: Git Configuration
    #########################################################

    - name: Share Git Configuration
      become: true
      block:
        - name: Copy gitconfig to claude user
          copy:
            src: "{{ source_home }}/.gitconfig"
            dest: "{{ target_home }}/.gitconfig"
            owner: "{{ target_user }}"
            group: "{{ target_user }}"
            mode: "0644"
            remote_src: true

    #########################################################
    # Section 2: SSH Configuration (config file only)
    #########################################################

    - name: Share SSH Configuration
      become: true
      block:
        - name: Ensure .ssh directory exists for claude
          file:
            path: "{{ target_home }}/.ssh"
            state: directory
            owner: "{{ target_user }}"
            group: "{{ target_user }}"
            mode: "0700"

        - name: Copy SSH config (without private keys)
          copy:
            src: "{{ source_home }}/.ssh/config"
            dest: "{{ target_home }}/.ssh/config"
            owner: "{{ target_user }}"
            group: "{{ target_user }}"
            mode: "0600"
            remote_src: true

    #########################################################
    # Section 3: X11 Display Access
    #########################################################

    - name: Configure X11 Display Access
      become: true
      block:
        - name: Add DISPLAY to claude's .bash_aliases
          lineinfile:
            path: "{{ target_home }}/.bash_aliases"
            regexp: '^export DISPLAY='
            line: 'export DISPLAY=":1"'
            create: true
            owner: "{{ target_user }}"
            group: "{{ target_user }}"
            mode: "0644"

        - name: Add DISPLAY to claude's .bashrc
          lineinfile:
            path: "{{ target_home }}/.bashrc"
            regexp: '^export DISPLAY='
            line: 'export DISPLAY=":1"'
            insertbefore: '^# If not running interactively'

    #########################################################
    # Section 4: SSH Agent Forwarding via ACL
    #########################################################

    - name: Configure SSH Agent Forwarding
      become: true
      block:
        - name: Grant claude user execute access to daniel's runtime directory
          acl:
            path: "/run/user/{{ daniel_uid }}"
            entity: "{{ target_user }}"
            etype: user
            permissions: rx
            state: present

        - name: Grant claude user access to gnupg directory
          acl:
            path: "/run/user/{{ daniel_uid }}/gnupg"
            entity: "{{ target_user }}"
            etype: user
            permissions: rx
            state: present
          ignore_errors: true

        - name: Grant claude user access to SSH agent socket
          acl:
            path: "/run/user/{{ daniel_uid }}/gnupg/S.gpg-agent.ssh"
            entity: "{{ target_user }}"
            etype: user
            permissions: rw
            state: present
          ignore_errors: true

        - name: Add SSH_AUTH_SOCK to claude's .bash_aliases
          lineinfile:
            path: "{{ target_home }}/.bash_aliases"
            regexp: '^export SSH_AUTH_SOCK='
            line: 'export SSH_AUTH_SOCK="/run/user/{{ daniel_uid }}/gnupg/S.gpg-agent.ssh"'
            create: true
            owner: "{{ target_user }}"
            group: "{{ target_user }}"
            mode: "0644"

        - name: Add SSH_AUTH_SOCK to claude's .bashrc
          lineinfile:
            path: "{{ target_home }}/.bashrc"
            regexp: '^export SSH_AUTH_SOCK='
            line: 'export SSH_AUTH_SOCK="/run/user/{{ daniel_uid }}/gnupg/S.gpg-agent.ssh"'
            insertbefore: '^# If not running interactively'

    #########################################################
    # Section 5: Grant Daniel ACL Access to Claude Home
    #########################################################

    - name: Grant Daniel ACL Access to Claude Home
      become: true
      block:
        - name: Grant daniel recursive rwx access to claude home
          acl:
            path: "{{ target_home }}"
            entity: "{{ source_user }}"
            etype: user
            permissions: rwx
            recursive: true
            state: present

        - name: Set default ACL for new files in claude home
          acl:
            path: "{{ target_home }}"
            entity: "{{ source_user }}"
            etype: user
            permissions: rwx
            default: true
            recursive: true
            state: present

    #########################################################
    # Section 6: Wezterm User Detection
    #########################################################

    - name: Configure Wezterm User Detection
      become: true
      block:
        - name: Add wezterm user variable to claude's bashrc
          blockinfile:
            path: "{{ target_home }}/.bashrc"
            marker: "# {mark} ANSIBLE MANAGED BLOCK - WEZTERM USER DETECTION"
            insertafter: "^\\[ -f ~/.bash_aliases \\]"
            block: |
              # Set wezterm user variable for user detection
              # This allows wezterm to know which user the shell is running as
              if [[ -n "$WEZTERM_PANE" ]]; then
                  __wezterm_set_user_var() {
                      printf "\033]1337;SetUserVar=%s=%s\007" "SHELL_USER" "$(echo -n "$USER" | base64)"
                  }
                  PROMPT_COMMAND="__wezterm_set_user_var${PROMPT_COMMAND:+;$PROMPT_COMMAND}"
              fi
