---
# Filename: setup_claude_worker_fortress.yml
#
# Ansible Playbook to create a "Fort Knox" secure AI agent environment.
#
# This playbook implements the Claude Worker Fortress architecture:
# 1. Install system prerequisites (bubblewrap, apparmor, etc.)
# 2. Create a dedicated "claude_worker" user with NO sudo access
# 3. Configure security settings (PAM limits, AppArmor profile)
# 4. Setup rootless Docker for the claude_worker user
# 5. Deploy fortress container files (Dockerfile, devcontainer.json, etc.)
# 6. Build the Docker image for the fortress container
# 7. Configure logging infrastructure for monitoring and reporting
# 8. Create container launch script for easy fortress deployment

- name: Configure Claude Worker Fortress Environment
  hosts: localhost
  gather_facts: false

  vars:
    claude_worker_user: "claude_worker"
    home_user: "daniel"
    nvm_version: "0.40.0"
    node_version: "22"
    log_base: "/var/log/claude-worker-fortress"
    fortress_files_dir: "files/claude-worker-fortress"
    fortress_template_dir: "files/claude-worker-fortress/template"
    fortress_scripts_dir: "files/claude-worker-fortress/scripts"

  tasks:
    #########################################################
    # Section 1: System Prerequisites
    #########################################################

    - name: Install System Prerequisites
      become: true
      block:
        - name: Install required packages for sandboxing
          apt:
            name:
              - bubblewrap
              - uidmap
              - dbus-user-session
              - fuse-overlayfs
              - slirp4netns
              - apparmor
              - apparmor-utils
              - acl
              - curl
              - git
            state: present
            update_cache: true

    #########################################################
    # Section 2: Create claude_worker User
    #########################################################

    - name: Create Claude Worker User and Configure Home Directory
      become: true
      block:
        - name: Create the 'claude_worker' user with NO sudo access
          user:
            name: "{{ claude_worker_user }}"
            comment: "Claude Worker Fortress User - No Sudo Access"
            shell: /bin/bash
            create_home: true
            groups: audio,video,input,render
            append: true
            state: present

        - name: Lock the 'claude_worker' user password immediately
          user:
            name: "{{ claude_worker_user }}"
            password_lock: true

        - name: Create .config directory
          file:
            path: "/home/{{ claude_worker_user }}/.config"
            state: directory
            owner: "{{ claude_worker_user }}"
            group: "{{ claude_worker_user }}"
            mode: "0700"

        - name: Create .local/bin directory
          file:
            path: "/home/{{ claude_worker_user }}/.local/bin"
            state: directory
            owner: "{{ claude_worker_user }}"
            group: "{{ claude_worker_user }}"
            mode: "0755"

        - name: Create .local/share directory
          file:
            path: "/home/{{ claude_worker_user }}/.local/share"
            state: directory
            owner: "{{ claude_worker_user }}"
            group: "{{ claude_worker_user }}"
            mode: "0755"

        - name: Create .cache directory
          file:
            path: "/home/{{ claude_worker_user }}/.cache"
            state: directory
            owner: "{{ claude_worker_user }}"
            group: "{{ claude_worker_user }}"
            mode: "0700"

        - name: Create workspace directory
          file:
            path: "/home/{{ claude_worker_user }}/workspace"
            state: directory
            owner: "{{ claude_worker_user }}"
            group: "{{ claude_worker_user }}"
            mode: "0755"

        - name: Create projects directory
          file:
            path: "/home/{{ claude_worker_user }}/projects"
            state: directory
            owner: "{{ claude_worker_user }}"
            group: "{{ claude_worker_user }}"
            mode: "0755"

        - name: Create minimal .gitconfig for claude_worker
          copy:
            dest: "/home/{{ claude_worker_user }}/.gitconfig"
            owner: "{{ claude_worker_user }}"
            group: "{{ claude_worker_user }}"
            mode: "0644"
            content: |
              [user]
                  name = danielr
                  email = danielratmiroff@gmail.com
              [init]
                  defaultBranch = master
              [core]
                  editor = vim

        - name: Deploy .bashrc configuration with XDG variables and DOCKER_HOST
          copy:
            dest: "/home/{{ claude_worker_user }}/.bashrc"
            owner: "{{ claude_worker_user }}"
            group: "{{ claude_worker_user }}"
            mode: "0644"
            content: |
              # ~/.bashrc: executed by bash(1) for non-login shells.

              # XDG Runtime Directory (required for rootless Docker and user services)
              # Set BEFORE interactive check - needed for non-interactive shells too
              if [ -z "$XDG_RUNTIME_DIR" ]; then
                  export XDG_RUNTIME_DIR="/run/user/$(id -u)"
              fi

              # If not running interactively, don't do anything else
              case $- in
                  *i*) ;;
                    *) return;;
              esac

              # XDG Base Directory Specification
              export XDG_CONFIG_HOME="$HOME/.config"
              export XDG_DATA_HOME="$HOME/.local/share"
              export XDG_CACHE_HOME="$HOME/.cache"
              export XDG_STATE_HOME="$HOME/.local/state"

              # Rootless Docker configuration
              export DOCKER_HOST=unix://$XDG_RUNTIME_DIR/docker.sock

              # History settings
              HISTCONTROL=ignoreboth
              HISTSIZE=1000
              HISTFILESIZE=2000
              shopt -s histappend

              # Check window size after each command
              shopt -s checkwinsize

              # Set PATH to include user's private bin if it exists
              if [ -d "$HOME/.local/bin" ]; then
                  PATH="$HOME/.local/bin:$PATH"
              fi

              # NVM initialization
              export NVM_DIR="$HOME/.nvm"
              [ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh"
              [ -s "$NVM_DIR/bash_completion" ] && \. "$NVM_DIR/bash_completion"

              # Fortress configuration
              export FORTRESS_TEMPLATE_DIR="$HOME/fortress/template"

              # Source bash aliases if it exists
              [ -f ~/.bash_aliases ] && . ~/.bash_aliases

              # Basic directory listing aliases
              alias ll='ls -alF'
              alias la='ls -A'
              alias l='ls -CF'
              alias ls='ls --color=auto'

              # Grep with color
              alias grep='grep --color=auto'
              alias fgrep='fgrep --color=auto'
              alias egrep='egrep --color=auto'

              # Safety aliases
              alias rm='rm -i'
              alias cp='cp -i'
              alias mv='mv -i'

              # Directory navigation
              alias ..='cd ..'
              alias ...='cd ../..'

              # CLAUDE
              alias cdash='uvx --from claude-dashboard cdash'
              alias clauded='claude --dangerously-skip-permissions'
              alias claudec='claude --chrome'

              # Chromium with Firejail sandbox
              alias chromium='firejail --profile=/etc/firejail/chromium-claude.profile chromium-browser'
              alias chrome='firejail --profile=/etc/firejail/chromium-claude.profile chromium-browser'

              # Tier shortcuts
              alias tier1='claude'  # Host Claude with browser support (use ssh -X)
              alias tier2='fortress-exec claude --dangerously-skip-permissions'  # Docker Claude

              # Basic prompt
              PS1='\u@\h:\w\$ '

    #########################################################
    # Section 3: Security Configuration
    #########################################################

    - name: Configure Security Settings
      become: true
      block:
        # 3.1 PAM Limits Configuration
        - name: Configure PAM limits for claude_worker user
          copy:
            dest: /etc/security/limits.d/99-claude-worker.conf
            owner: root
            group: root
            mode: "0644"
            content: |
              # Resource limits for claude_worker user
              claude_worker  soft    nofile  65536
              claude_worker  hard    nofile  65536
              claude_worker  soft    nproc   4096
              claude_worker  hard    nproc   4096
              claude_worker  soft    memlock unlimited
              claude_worker  hard    memlock unlimited

        # 3.2 AppArmor Profile for Claude Worker Fortress
        - name: Create AppArmor profile for claude-worker-fortress
          copy:
            dest: /etc/apparmor.d/claude-worker-fortress
            owner: root
            group: root
            mode: "0644"
            content: |
              # AppArmor profile for Claude Worker Fortress
              # This profile runs in enforce mode (logs and blocks violations)
              # Allows Docker operations while denying access to sensitive locations

              #include <tunables/global>

              profile claude-worker-fortress flags=(audit) {
                #include <abstractions/base>

                # Capabilities needed for Docker operations
                capability sys_admin,
                capability sys_chroot,
                capability setuid,
                capability setgid,
                capability net_admin,
                capability net_raw,

                # Network access for Docker and container operations
                network inet stream,
                network inet6 stream,
                network inet dgram,
                network inet6 dgram,
                network unix stream,
                network unix dgram,

                # Read-only access to system directories
                /usr/** r,
                /lib/** r,
                /lib64/** r,
                /bin/** r,
                /sbin/** r,
                /etc/** r,

                # Read-write access to claude_worker home directory (owned files)
                /home/claude_worker/** rw,
                owner /home/claude_worker/** rw,

                # Docker socket and runtime access
                /run/user/*/docker.sock rw,
                /run/user/*/** rw,

                # Read-write access to /tmp
                /tmp/** rw,

                # Deny and audit access to sensitive locations
                audit deny /home/daniel/** rw,
                audit deny /root/** rw,
                audit deny /etc/shadow rw,
                audit deny /etc/gshadow rw,
                audit deny /etc/sudoers* rw,
              }

        # 3.3 Load AppArmor Profile in Enforce Mode
        - name: Load AppArmor profile (enforce mode)
          command: apparmor_parser -r /etc/apparmor.d/claude-worker-fortress
          changed_when: true

        - name: Verify AppArmor profile is in enforce mode
          shell: |
            aa-status --enabled 2>/dev/null && \
            aa-status 2>/dev/null | sed -n '/profiles are in enforce mode/,/profiles are in complain mode/p' | grep -q "claude-worker-fortress"
          register: apparmor_verify
          changed_when: false
          failed_when: apparmor_verify.rc != 0

        # 3.3 Install Firejail and Chromium for Host Browser
        - name: Install Firejail for browser sandboxing
          apt:
            name: firejail
            state: present

        - name: Install Chromium browser
          apt:
            name: chromium-browser
            state: present

        - name: Install xauth for X11 forwarding
          apt:
            name: xauth
            state: present

        - name: Create Firejail profiles directory
          file:
            path: /etc/firejail
            state: directory
            owner: root
            group: root
            mode: "0755"

        - name: Deploy Firejail profile for Chromium
          copy:
            src: "{{ fortress_files_dir }}/firejail/chromium-claude.profile"
            dest: /etc/firejail/chromium-claude.profile
            owner: root
            group: root
            mode: "0644"

        # 3.4 Configure SSH for X11 Forwarding (only if SSH server is installed)
        - name: Check if sshd_config exists
          stat:
            path: /etc/ssh/sshd_config
          register: sshd_config_stat

        - name: Ensure X11Forwarding is enabled in sshd_config
          lineinfile:
            path: /etc/ssh/sshd_config
            regexp: '^#?X11Forwarding'
            line: 'X11Forwarding yes'
          notify: restart sshd
          when: sshd_config_stat.stat.exists

        - name: Ensure X11UseLocalhost is set
          lineinfile:
            path: /etc/ssh/sshd_config
            regexp: '^#?X11UseLocalhost'
            line: 'X11UseLocalhost yes'
          notify: restart sshd
          when: sshd_config_stat.stat.exists

    #########################################################
    # Section 4: Rootless Docker Setup
    #########################################################

    - name: Configure Rootless Docker for Claude Worker User
      become: true
      block:
        # 4.1 Get Claude Worker User UID/GID
        - name: Get claude_worker user UID
          getent:
            database: passwd
            key: "{{ claude_worker_user }}"
          register: claude_worker_passwd

        - name: Set claude_worker UID and GID facts
          set_fact:
            claude_worker_uid: "{{ claude_worker_passwd.ansible_facts.getent_passwd[claude_worker_user][1] }}"
            claude_worker_gid: "{{ claude_worker_passwd.ansible_facts.getent_passwd[claude_worker_user][2] }}"

        # 4.2 Configure Subordinate UIDs/GIDs
        - name: Configure subordinate UIDs for claude_worker user
          lineinfile:
            path: /etc/subuid
            regexp: "^{{ claude_worker_user }}:"
            line: "{{ claude_worker_user }}:100000:65536"
            create: true
            owner: root
            group: root
            mode: "0644"

        - name: Configure subordinate GIDs for claude_worker user
          lineinfile:
            path: /etc/subgid
            regexp: "^{{ claude_worker_user }}:"
            line: "{{ claude_worker_user }}:100000:65536"
            create: true
            owner: root
            group: root
            mode: "0644"

        # 4.3 Install Docker Prerequisites for Rootless
        - name: Install prerequisites for Docker repository
          apt:
            name:
              - ca-certificates
              - curl
              - gnupg
            state: present

        - name: Create directory for Docker GPG key
          file:
            path: /etc/apt/keyrings
            state: directory
            mode: "0755"

        - name: Download Docker GPG key
          get_url:
            url: https://download.docker.com/linux/ubuntu/gpg
            dest: /etc/apt/keyrings/docker.asc
            mode: "0644"

        - name: Get system architecture
          command: dpkg --print-architecture
          register: dpkg_arch
          changed_when: false

        - name: Get Ubuntu version codename
          shell: . /etc/os-release && echo "$VERSION_CODENAME"
          register: ubuntu_codename
          changed_when: false

        - name: Add Docker apt repository
          apt_repository:
            repo: "deb [arch={{ dpkg_arch.stdout }} signed-by=/etc/apt/keyrings/docker.asc] https://download.docker.com/linux/ubuntu {{ ubuntu_codename.stdout }} stable"
            filename: docker
            state: present

        - name: Install Docker packages for rootless mode
          apt:
            name:
              - docker-ce
              - docker-ce-cli
              - containerd.io
              - docker-buildx-plugin
              - docker-compose-plugin
              - docker-ce-rootless-extras
              - uidmap
              - fuse-overlayfs
              - slirp4netns
            state: present
            update_cache: true

        # 4.4 Enable Lingering for Claude Worker User
        - name: Enable lingering for claude_worker user
          command: loginctl enable-linger {{ claude_worker_user }}
          args:
            creates: /var/lib/systemd/linger/{{ claude_worker_user }}

        # 4.5 Setup Rootless Docker for Claude Worker User
        - name: Check if rootless docker is already installed
          stat:
            path: "/home/{{ claude_worker_user }}/.config/systemd/user/docker.service"
          register: rootless_docker_service

        - name: Install rootless docker for claude_worker user
          become_user: "{{ claude_worker_user }}"
          shell: |
            export XDG_RUNTIME_DIR=/run/user/{{ claude_worker_uid }}
            export DBUS_SESSION_BUS_ADDRESS=unix:path=/run/user/{{ claude_worker_uid }}/bus
            /usr/bin/dockerd-rootless-setuptool.sh install
          args:
            creates: "/home/{{ claude_worker_user }}/.config/systemd/user/docker.service"
          environment:
            HOME: "/home/{{ claude_worker_user }}"
            PATH: "/usr/bin:/bin:/usr/sbin:/sbin"
          when: not rootless_docker_service.stat.exists

        # 4.6 Enable Rootless Docker Service
        - name: Enable rootless docker service for claude_worker user
          become_user: "{{ claude_worker_user }}"
          shell: |
            export XDG_RUNTIME_DIR=/run/user/{{ claude_worker_uid }}
            export DBUS_SESSION_BUS_ADDRESS=unix:path=/run/user/{{ claude_worker_uid }}/bus
            systemctl --user enable docker.service
            systemctl --user start docker.service
          environment:
            HOME: "/home/{{ claude_worker_user }}"
          args:
            executable: /bin/bash
          when: not rootless_docker_service.stat.exists

        # 4.7 Configure DOCKER_HOST Environment (already in .bashrc from Section 2)
        - name: Verify DOCKER_HOST is configured in .bashrc
          lineinfile:
            path: "/home/{{ claude_worker_user }}/.bashrc"
            regexp: '^export DOCKER_HOST='
            line: 'export DOCKER_HOST=unix://$XDG_RUNTIME_DIR/docker.sock'
            state: present
            owner: "{{ claude_worker_user }}"
            group: "{{ claude_worker_user }}"

    #########################################################
    # Section 5: Node.js and DevContainers CLI
    #########################################################

    - name: Install Node.js and DevContainers CLI for Claude Worker User
      become: true
      block:
        # 5.1 Install NVM for claude_worker user
        - name: Check if NVM is already installed
          stat:
            path: "/home/{{ claude_worker_user }}/.nvm/nvm.sh"
          register: nvm_installed

        - name: Download and install NVM
          become_user: "{{ claude_worker_user }}"
          shell: |
            curl -o- https://raw.githubusercontent.com/nvm-sh/nvm/v{{ nvm_version }}/install.sh | bash
          args:
            creates: "/home/{{ claude_worker_user }}/.nvm/nvm.sh"
          environment:
            HOME: "/home/{{ claude_worker_user }}"
          when: not nvm_installed.stat.exists

        # 5.2 Install Node.js using NVM
        - name: Install Node.js via NVM
          become_user: "{{ claude_worker_user }}"
          shell: |
            export NVM_DIR="$HOME/.nvm"
            [ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh"
            nvm install {{ node_version }}
            nvm use {{ node_version }}
            nvm alias default {{ node_version }}
          args:
            executable: /bin/bash
          environment:
            HOME: "/home/{{ claude_worker_user }}"
          register: node_install_result
          changed_when: "'is already installed' not in node_install_result.stderr"

        # 5.3 Install @devcontainers/cli globally
        - name: Install @devcontainers/cli globally
          become_user: "{{ claude_worker_user }}"
          shell: |
            export NVM_DIR="$HOME/.nvm"
            [ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh"
            npm install -g @devcontainers/cli
          args:
            executable: /bin/bash
          environment:
            HOME: "/home/{{ claude_worker_user }}"
          register: devcontainer_install_result
          changed_when: "'added' in devcontainer_install_result.stdout or 'up to date' not in devcontainer_install_result.stderr"

        # 5.4 Verify devcontainer CLI installation
        - name: Verify devcontainer CLI is installed
          become_user: "{{ claude_worker_user }}"
          shell: |
            export NVM_DIR="$HOME/.nvm"
            [ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh"
            devcontainer --version
          args:
            executable: /bin/bash
          environment:
            HOME: "/home/{{ claude_worker_user }}"
          register: devcontainer_version
          changed_when: false

        - name: Display devcontainer CLI version
          debug:
            msg: "DevContainers CLI version: {{ devcontainer_version.stdout }}"

        # 5.5 Install Claude Code CLI for host-level use
        - name: Install Claude Code CLI for claude_worker
          become_user: "{{ claude_worker_user }}"
          shell: |
            export NVM_DIR="$HOME/.nvm"
            [ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh"
            npm install -g @anthropic-ai/claude-code
          args:
            executable: /bin/bash
          environment:
            HOME: "/home/{{ claude_worker_user }}"

    #########################################################
    # Section 6: Deploy Fortress Container Files
    #########################################################

    - name: Deploy Fortress Container Files
      become: true
      block:
        # 6.1 Create Fortress Directory
        - name: Create fortress directory
          file:
            path: "/home/{{ claude_worker_user }}/fortress"
            state: directory
            owner: "{{ claude_worker_user }}"
            group: "{{ claude_worker_user }}"
            mode: "0755"

        # 5.2 Create fortress/template directory
        - name: Create fortress/template directory
          file:
            path: "/home/{{ claude_worker_user }}/fortress/template"
            state: directory
            owner: "{{ claude_worker_user }}"
            group: "{{ claude_worker_user }}"
            mode: "0755"

        # 5.3 Copy template files
        - name: Copy Dockerfile to fortress/template directory
          copy:
            src: "{{ fortress_template_dir }}/Dockerfile"
            dest: "/home/{{ claude_worker_user }}/fortress/template/Dockerfile"
            owner: "{{ claude_worker_user }}"
            group: "{{ claude_worker_user }}"
            mode: "0644"

        - name: Copy devcontainer.json to fortress/template directory
          copy:
            src: "{{ fortress_template_dir }}/devcontainer.json"
            dest: "/home/{{ claude_worker_user }}/fortress/template/devcontainer.json"
            owner: "{{ claude_worker_user }}"
            group: "{{ claude_worker_user }}"
            mode: "0644"

        - name: Copy entrypoint.sh to fortress/template directory
          copy:
            src: "{{ fortress_template_dir }}/entrypoint.sh"
            dest: "/home/{{ claude_worker_user }}/fortress/template/entrypoint.sh"
            owner: "{{ claude_worker_user }}"
            group: "{{ claude_worker_user }}"
            mode: "0755"

        - name: Copy init-firewall.sh to fortress/template directory
          copy:
            src: "{{ fortress_template_dir }}/init-firewall.sh"
            dest: "/home/{{ claude_worker_user }}/fortress/template/init-firewall.sh"
            owner: "{{ claude_worker_user }}"
            group: "{{ claude_worker_user }}"
            mode: "0755"

        - name: Copy settings.json to fortress/template directory
          copy:
            src: "{{ fortress_template_dir }}/settings.json"
            dest: "/home/{{ claude_worker_user }}/fortress/template/settings.json"
            owner: "{{ claude_worker_user }}"
            group: "{{ claude_worker_user }}"
            mode: "0644"

        # 5.4 Copy helper scripts to .local/bin
        - name: Copy fortress-init script
          copy:
            src: "{{ fortress_scripts_dir }}/fortress-init"
            dest: "/home/{{ claude_worker_user }}/.local/bin/fortress-init"
            owner: "{{ claude_worker_user }}"
            group: "{{ claude_worker_user }}"
            mode: "0755"

        - name: Copy fortress-up script
          copy:
            src: "{{ fortress_scripts_dir }}/fortress-up"
            dest: "/home/{{ claude_worker_user }}/.local/bin/fortress-up"
            owner: "{{ claude_worker_user }}"
            group: "{{ claude_worker_user }}"
            mode: "0755"

        - name: Copy fortress-exec script
          copy:
            src: "{{ fortress_scripts_dir }}/fortress-exec"
            dest: "/home/{{ claude_worker_user }}/.local/bin/fortress-exec"
            owner: "{{ claude_worker_user }}"
            group: "{{ claude_worker_user }}"
            mode: "0755"

    #########################################################
    # Section 7: Build Docker Image (Pre-build for faster startup)
    #########################################################

    - name: Build Docker Image
      become: true
      block:
        - name: Build the fortress Docker image as claude_worker user
          become_user: "{{ claude_worker_user }}"
          shell: |
            export XDG_RUNTIME_DIR=/run/user/{{ claude_worker_uid }}
            export DOCKER_HOST=unix://$XDG_RUNTIME_DIR/docker.sock
            docker build -t claude-fortress /home/{{ claude_worker_user }}/fortress/template/
          environment:
            HOME: "/home/{{ claude_worker_user }}"
          args:
            executable: /bin/bash
          register: docker_build_result
          changed_when: "'Successfully built' in docker_build_result.stdout or 'Successfully tagged' in docker_build_result.stdout or docker_build_result.rc == 0"

        - name: Tag the fortress Docker image
          become_user: "{{ claude_worker_user }}"
          shell: |
            export XDG_RUNTIME_DIR=/run/user/{{ claude_worker_uid }}
            export DOCKER_HOST=unix://$XDG_RUNTIME_DIR/docker.sock
            docker tag claude-fortress claude-fortress:latest
          environment:
            HOME: "/home/{{ claude_worker_user }}"
          args:
            executable: /bin/bash
          changed_when: false

    #########################################################
    # Section 8: Logging Infrastructure
    #########################################################

    - name: Configure Logging Infrastructure
      become: true
      block:
        # 7.1 Create Log Directory Structure
        - name: Create main log directory
          file:
            path: "{{ log_base }}"
            state: directory
            owner: root
            group: adm
            mode: "0755"

        - name: Create apparmor log directory
          file:
            path: "{{ log_base }}/apparmor"
            state: directory
            owner: root
            group: adm
            mode: "0755"

        - name: Create violations log directory
          file:
            path: "{{ log_base }}/violations"
            state: directory
            owner: root
            group: adm
            mode: "0755"

        - name: Create reports log directory
          file:
            path: "{{ log_base }}/reports"
            state: directory
            owner: root
            group: adm
            mode: "0755"

        # 7.2 Create Logrotate Configuration
        - name: Create logrotate configuration for claude-worker-fortress
          copy:
            dest: /etc/logrotate.d/claude-worker-fortress
            owner: root
            group: root
            mode: "0644"
            content: |
              /var/log/claude-worker-fortress/*/*.log {
                  daily
                  rotate 30
                  compress
                  delaycompress
                  notifempty
                  missingok
                  create 0644 root adm
                  dateext
                  dateformat -%Y%m%d
              }

        # 7.3 Create Real-Time Monitor Script
        - name: Deploy real-time violation monitor script
          copy:
            dest: /usr/local/bin/claude-worker-fortress-monitor.sh
            owner: root
            group: root
            mode: "0755"
            content: |
              #!/bin/bash
              # Real-time monitor for Claude Worker Fortress violations
              # Watches AppArmor audit logs for claude-worker-fortress profile violations

              LOG_DIR="/var/log/claude-worker-fortress"
              VIOLATIONS_LOG="$LOG_DIR/violations/violations.log"

              echo "Starting Claude Worker Fortress Monitor..."
              echo "Watching for AppArmor violations..."
              echo "Press Ctrl+C to stop."
              echo ""

              # Monitor kernel audit logs for apparmor denials
              journalctl -f -k | grep --line-buffered -E "(apparmor|DENIED|claude-worker-fortress)" | while read line; do
                  timestamp=$(date '+%Y-%m-%d %H:%M:%S')
                  echo "[$timestamp] $line"
                  echo "[$timestamp] $line" >> "$VIOLATIONS_LOG"
              done

        # 7.4 Create Daily Report Script
        - name: Deploy daily report generator script
          copy:
            dest: /usr/local/bin/claude-worker-fortress-report.sh
            owner: root
            group: root
            mode: "0755"
            content: |
              #!/bin/bash
              # Daily report generator for Claude Worker Fortress
              # Generates a summary of violations and activity

              LOG_DIR="/var/log/claude-worker-fortress"
              REPORT_DIR="$LOG_DIR/reports"
              DATE=$(date '+%Y-%m-%d')
              REPORT_FILE="$REPORT_DIR/report-$DATE.txt"

              echo "Claude Worker Fortress Daily Report - $DATE" > "$REPORT_FILE"
              echo "=========================================" >> "$REPORT_FILE"
              echo "" >> "$REPORT_FILE"

              # Count violations from the last 24 hours
              echo "## Violations Summary" >> "$REPORT_FILE"
              if [ -f "$LOG_DIR/violations/violations.log" ]; then
                  VIOLATION_COUNT=$(grep -c "$(date '+%Y-%m-%d')" "$LOG_DIR/violations/violations.log" 2>/dev/null || echo "0")
                  echo "Total violations today: $VIOLATION_COUNT" >> "$REPORT_FILE"
              else
                  echo "No violations log found." >> "$REPORT_FILE"
              fi
              echo "" >> "$REPORT_FILE"

              # AppArmor status
              echo "## AppArmor Profile Status" >> "$REPORT_FILE"
              aa-status 2>/dev/null | grep -A5 "profiles are in enforce mode" >> "$REPORT_FILE" || echo "Unable to retrieve AppArmor status" >> "$REPORT_FILE"
              echo "" >> "$REPORT_FILE"

              # Docker container status
              echo "## Docker Container Status" >> "$REPORT_FILE"
              sudo -u claude_worker bash -c 'export XDG_RUNTIME_DIR=/run/user/$(id -u); export DOCKER_HOST=unix://$XDG_RUNTIME_DIR/docker.sock; docker ps -a --filter name=claude-fortress' 2>/dev/null >> "$REPORT_FILE" || echo "Unable to retrieve Docker status" >> "$REPORT_FILE"
              echo "" >> "$REPORT_FILE"

              echo "Report generated: $REPORT_FILE"

        # 7.5 Set Permissions on Log Directory for daniel User
        - name: Grant daniel user read access to log directory
          acl:
            path: "{{ log_base }}"
            entity: "{{ home_user }}"
            etype: user
            permissions: rx
            recursive: true
            state: present

        - name: Set default ACL for daniel user on log directory
          acl:
            path: "{{ log_base }}"
            entity: "{{ home_user }}"
            etype: user
            permissions: rx
            default: true
            recursive: true
            state: present

    #########################################################
    # Section 9: Create Container Launch Script (Legacy)
    #########################################################

    - name: Create Container Launch Script
      become: true
      block:
        - name: Create start-fortress.sh script
          copy:
            dest: "/home/{{ claude_worker_user }}/start-fortress.sh"
            owner: "{{ claude_worker_user }}"
            group: "{{ claude_worker_user }}"
            mode: "0755"
            content: |
              #!/bin/bash
              # Start the Claude Fortress container
              # This script launches the secure fortress container with appropriate settings

              # Set up Docker environment for rootless mode
              export XDG_RUNTIME_DIR="/run/user/$(id -u)"
              export DOCKER_HOST="unix://$XDG_RUNTIME_DIR/docker.sock"

              # Default VNC password (user should change this)
              VNC_PASSWORD="${VNC_PASSWORD:-changeme}"

              # Container name
              CONTAINER_NAME="claude-fortress"

              # Check if container already exists
              if docker ps -a --format '{% raw %}{{.Names}}{% endraw %}' | grep -q "^${CONTAINER_NAME}$"; then
                  echo "Container '${CONTAINER_NAME}' already exists."
                  echo "To restart, run: docker rm -f ${CONTAINER_NAME} && $0"
                  echo "To view logs, run: docker logs ${CONTAINER_NAME}"
                  exit 1
              fi

              echo "Starting Claude Fortress container..."
              echo "VNC will be available at: http://127.0.0.1:6080"
              echo ""

              docker run -d \
                  --name "${CONTAINER_NAME}" \
                  --cap-add=NET_ADMIN \
                  --cap-add=NET_RAW \
                  --security-opt=no-new-privileges:true \
                  -p 127.0.0.1:6080:6080 \
                  -v /home/claude_worker/workspace:/workspace \
                  -e VNC_PASSWORD="${VNC_PASSWORD}" \
                  claude-fortress

              if [ $? -eq 0 ]; then
                  echo ""
                  echo "Container started successfully!"
                  echo "Access VNC at: http://127.0.0.1:6080"
                  echo ""
                  echo "Useful commands:"
                  echo "  View logs:    docker logs -f ${CONTAINER_NAME}"
                  echo "  Stop:         docker stop ${CONTAINER_NAME}"
                  echo "  Start:        docker start ${CONTAINER_NAME}"
                  echo "  Remove:       docker rm -f ${CONTAINER_NAME}"
                  echo "  Shell access: docker exec -it ${CONTAINER_NAME} /bin/bash"
              else
                  echo "Failed to start container. Check Docker logs for details."
                  exit 1
              fi

  handlers:
    - name: restart sshd
      service:
        name: sshd
        state: restarted
      when: sshd_config_stat is defined and sshd_config_stat.stat.exists
